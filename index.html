<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Cloudflare Markdown Notes</title>
  <link rel="stylesheet" href="style.css" />
  <script src="./marked.min.js"></script>
</head>
<body>
  <div id="auth">
    <h2>ç™»å½• / æ³¨å†Œ</h2>
    <input id="username" placeholder="ç”¨æˆ·å" />
    <input id="password" placeholder="å¯†ç " type="password" />
    <button onclick="login()">ç™»å½•</button>
    <button onclick="register()">æ³¨å†Œ</button>
    <p id="authMsg"></p>
  </div>

  <div id="app" style="display:none;">
    <h2>Markdown ç¬”è®°</h2>
    <button onclick="logout()">é€€å‡ºç™»å½•</button>
    <div id="notes"></div>
    <button onclick="newNote()">ï¼‹ æ–°å»ºç¬”è®°</button>
    <hr/>
    <input id="noteTitle" placeholder="ç¬”è®°æ ‡é¢˜" />
    <textarea id="editor" placeholder="åœ¨è¿™é‡Œè¾“å…¥ Markdown..."></textarea>
    <div id="preview"></div>
    <button onclick="saveNote()">ğŸ’¾ ä¿å­˜</button>
  </div>

  <div id="share-section" style="margin-top: 1em; border-top: 1px solid #ccc; padding-top: 1em;">
  <h3>ğŸ”— ç¬”è®°å…±äº«</h3>

  <div>
    <input type="text" id="share-target" placeholder="è¾“å…¥è¦å…±äº«çš„ç”¨æˆ·å" />
    <select id="share-permission">
      <option value="read">åªè¯»</option>
      <option value="edit">å¯ç¼–è¾‘</option>
    </select>
    <button id="share-btn">åˆ†äº«ç¬”è®°</button>
  </div>

  <div id="shared-users" style="margin-top: 0.5em;"></div>
</div>


  <script>
    const API_BASE = "https://md.vhadx.workers.dev"; // âš ï¸ æ›¿æ¢ä¸ºä½ çš„ Worker åœ°å€
    let currentId = null;

    // ç™»å½•æ³¨å†Œ
    async function login() {
      const u = username.value, p = password.value;
      const res = await fetch(API_BASE + "/api/login", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: u, password: p })
      });
      const data = await res.json();
      if (data.token) {
        localStorage.setItem("token", data.token);
        showApp();
      } else authMsg.textContent = data.error;
    }

    async function register() {
      const u = username.value, p = password.value;
      const res = await fetch(API_BASE + "/api/register", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: u, password: p })
      });
      const data = await res.json();
      authMsg.textContent = data.success ? "æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•" : data.error;
    }

    function logout() {
      localStorage.removeItem("token");
      location.reload();
    }

    async function showApp() {
      auth.style.display = "none";
      app.style.display = "block";
      loadNotes();
    }

    // åŠ è½½ç¬”è®°åˆ—è¡¨
    async function loadNotes() {
      const res = await fetch(API_BASE + "/api/notes", {
        headers: { Authorization: "Bearer " + localStorage.token }
      });
      const notes = await res.json();
      notesDiv = document.getElementById("notes");
      notesDiv.innerHTML = "";
      notes.forEach(n => {
        const btn = document.createElement("button");
        btn.textContent = n.title || "ï¼ˆæ— æ ‡é¢˜ï¼‰";
        btn.onclick = () => loadNote(n.id);
        notesDiv.appendChild(btn);
      });
    }

    async function loadNote(id) {
      const res = await fetch(API_BASE + "/api/note/" + id, {
        headers: { Authorization: "Bearer " + localStorage.token }
      });
      const data = await res.json();
      currentId = id;
      noteTitle.value = data.title;
      editor.value = data.content;
      updatePreview();
    }

    function newNote() {
      currentId = null;
      noteTitle.value = "";
      editor.value = "";
      updatePreview();
    }

    async function saveNote() {
      const payload = {
        id: currentId,
        title: noteTitle.value,
        content: editor.value,
        sharedWith: [] // æœªæ¥å¯æ”¯æŒå…±äº«
      };
      const res = await fetch(API_BASE + "/api/note", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + localStorage.token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      alert("ç¬”è®°å·²ä¿å­˜");
      currentId = data.id;
      loadNotes();
    }

    function updatePreview() {
      preview.innerHTML = marked.parse(editor.value);
    }

    editor?.addEventListener("input", updatePreview);

    // è‡ªåŠ¨ç™»å½•çŠ¶æ€
    if (localStorage.token) showApp();

const token = localStorage.getItem("token");

// è·å–å½“å‰ç¬”è®° IDï¼ˆä½ å¯ä»¥æ ¹æ®å®é™…é€»è¾‘ä¿®æ”¹ï¼‰
const noteId = currentNoteId || "abc123"; 

// åˆ†äº«æŒ‰é’®äº‹ä»¶
document.getElementById("share-btn").addEventListener("click", async () => {
  const targetUser = document.getElementById("share-target").value.trim();
  const permission = document.getElementById("share-permission").value;

  if (!targetUser) {
    alert("è¯·è¾“å…¥è¦å…±äº«çš„ç”¨æˆ·å");
    return;
  }

  const res = await fetch(`${API_BASE}/api/share`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token,
    },
    body: JSON.stringify({ noteId, targetUser, permission }),
  });

  const data = await res.json();
  if (res.ok) {
    alert("âœ… å·²å…±äº«ç»™ " + targetUser);
    loadSharedUsers();
  } else {
    alert("âŒ åˆ†äº«å¤±è´¥ï¼š" + (data.error || res.statusText));
  }
});

// åŠ è½½å…±äº«åˆ—è¡¨
async function loadSharedUsers() {
  const res = await fetch(`${API_BASE}/api/note/${noteId}`, {
    headers: { Authorization: "Bearer " + token },
  });
  if (!res.ok) return;

  const note = await res.json();
  const container = document.getElementById("shared-users");
  container.innerHTML = "<h4>å·²å…±äº«ç”¨æˆ·ï¼š</h4>";

  if (note.permissions) {
    for (const [user, perm] of Object.entries(note.permissions)) {
      const div = document.createElement("div");
      div.innerHTML = `
        ğŸ‘¤ ${user}ï¼ˆ${perm === "edit" ? "å¯ç¼–è¾‘" : "åªè¯»"}ï¼‰
        <button onclick="revokeShare('${noteId}', '${user}')">æ’¤é”€</button>
      `;
      container.appendChild(div);
    }
  } else {
    container.innerHTML += "<p>æš‚æ— å…±äº«ç”¨æˆ·</p>";
  }
}

// æ’¤é”€å…±äº«
async function revokeShare(noteId, targetUser) {
  if (!confirm(`ç¡®å®šè¦æ’¤é”€ ${targetUser} çš„è®¿é—®æƒé™å—ï¼Ÿ`)) return;

  const res = await fetch(`${API_BASE}/api/share/${noteId}/${targetUser}`, {
    method: "DELETE",
    headers: { Authorization: "Bearer " + token },
  });

  if (res.ok) {
    alert("âœ… å·²æ’¤é”€å…±äº«");
    loadSharedUsers();
  } else {
    const data = await res.json();
    alert("âŒ æ’¤é”€å¤±è´¥ï¼š" + (data.error || res.statusText));
  }
}

// åˆå§‹åŒ–æ—¶åŠ è½½å…±äº«çŠ¶æ€
loadSharedUsers();
    
  </script>
</body>
</html>



